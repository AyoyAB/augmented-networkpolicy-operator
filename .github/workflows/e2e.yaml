name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version: "1.25"

      - name: Install Kind
        run: |
          go install sigs.k8s.io/kind@v0.24.0

      - name: Create Kind cluster
        run: kind create cluster --name e2e-test

      - name: Generate manifests
        run: |
          make generate
          make manifests

      - name: Build and load image
        run: |
          make docker-build IMG=ghcr.io/ayoyab/augmented-networkpolicy-operator:e2e
          kind load docker-image ghcr.io/ayoyab/augmented-networkpolicy-operator:e2e --name e2e-test

      - name: Deploy operator
        run: make deploy IMG=ghcr.io/ayoyab/augmented-networkpolicy-operator:e2e

      - name: Wait for operator to be ready
        run: |
          kubectl wait --for=condition=available --timeout=120s \
            deployment/augmented-networkpolicy-operator-controller-manager \
            -n augmented-networkpolicy-operator-system

      - name: Install Chainsaw
        run: make chainsaw

      - name: Run e2e tests
        run: ./bin/chainsaw test --test-dir ./e2e/ --config ./e2e/.chainsaw.yaml

      - name: Collect logs on failure
        if: failure()
        run: |
          kubectl logs -n augmented-networkpolicy-operator-system \
            deployment/augmented-networkpolicy-operator-controller-manager \
            --tail=100 || true

      - name: Delete Kind cluster
        if: always()
        run: kind delete cluster --name e2e-test
