name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version-file: go.mod

      - name: Cache tool binaries
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: bin/
          key: tools-${{ runner.os }}-${{ hashFiles('Makefile') }}

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create Kind cluster
        run: kind create cluster --name e2e-test

      - name: Generate manifests
        run: |
          make generate
          make manifests

      - name: Build and load image
        run: |
          make docker-build IMG=ghcr.io/ayoyab/augmented-networkpolicy-operator:e2e
          kind load docker-image ghcr.io/ayoyab/augmented-networkpolicy-operator:e2e --name e2e-test

      - name: Deploy operator
        run: make deploy IMG=ghcr.io/ayoyab/augmented-networkpolicy-operator:e2e

      - name: Wait for operator to be ready
        run: |
          kubectl wait --for=condition=available --timeout=120s \
            deployment/augmented-networkpolicy-operator-controller-manager \
            -n augmented-networkpolicy-operator-system

      - name: Install Chainsaw
        run: make chainsaw

      - name: Run e2e tests
        run: ./bin/chainsaw test --test-dir ./e2e/ --config ./e2e/.chainsaw.yaml

      - name: Collect logs on failure
        if: failure()
        run: |
          kubectl logs -n augmented-networkpolicy-operator-system \
            deployment/augmented-networkpolicy-operator-controller-manager \
            --tail=100 || true

      - name: Delete Kind cluster
        if: always()
        run: kind delete cluster --name e2e-test
