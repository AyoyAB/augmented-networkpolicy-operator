name: Helm Docs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  helm-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install helm-docs
        run: |
          HELM_DOCS_VERSION=1.14.2
          curl -sSL "https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz" \
            | tar xz -C /usr/local/bin helm-docs

      - name: Run helm-docs
        run: helm-docs --chart-search-root charts/

      - name: Check for drift
        run: |
          if ! git diff --exit-code charts/; then
            echo "::error::Helm chart README is out of date. Run 'make helm-docs' and commit the result."
            git diff charts/
            exit 1
          fi
