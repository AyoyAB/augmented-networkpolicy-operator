apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: metrics
spec:
  description: Verify Prometheus metrics are exposed and incremented
  steps:
    - name: create-augmented-networkpolicy
      try:
        - apply:
            resource:
              apiVersion: networking.ayoy.se/v1alpha1
              kind: NetworkPolicy
              metadata:
                name: test-metrics
              spec:
                podSelector:
                  matchLabels:
                    app: web
                policyTypes:
                  - Egress
                egress:
                  - ports:
                      - protocol: TCP
                        port: 443
                    to:
                      - hostname: kubernetes.default.svc.cluster.local
    - name: assert-standard-networkpolicy-created
      try:
        - assert:
            resource:
              apiVersion: networking.k8s.io/v1
              kind: NetworkPolicy
              metadata:
                name: test-metrics
    - name: assert-creation-metric
      try:
        - script:
            timeout: 120s
            content: |
              kubectl run curl-metrics-create --image=curlimages/curl --restart=Never -- \
                -sf http://augmented-networkpolicy-operator-controller-manager-metrics.augmented-networkpolicy-operator-system.svc:8080/metrics
              kubectl wait --for=jsonpath='{.status.phase}'=Succeeded pod/curl-metrics-create --timeout=90s
              kubectl logs curl-metrics-create | grep -E '^augmented_networkpolicy_creations_total [1-9]'
              kubectl delete pod curl-metrics-create --ignore-not-found
    - name: delete-augmented-networkpolicy
      try:
        - delete:
            ref:
              apiVersion: networking.ayoy.se/v1alpha1
              kind: NetworkPolicy
              name: test-metrics
    - name: assert-standard-networkpolicy-deleted
      try:
        - error:
            resource:
              apiVersion: networking.k8s.io/v1
              kind: NetworkPolicy
              metadata:
                name: test-metrics
    - name: assert-deletion-metric
      try:
        - script:
            timeout: 120s
            content: |
              kubectl run curl-metrics-delete --image=curlimages/curl --restart=Never -- \
                -sf http://augmented-networkpolicy-operator-controller-manager-metrics.augmented-networkpolicy-operator-system.svc:8080/metrics
              kubectl wait --for=jsonpath='{.status.phase}'=Succeeded pod/curl-metrics-delete --timeout=90s
              kubectl logs curl-metrics-delete | grep -E '^augmented_networkpolicy_deletions_total [1-9]'
              kubectl delete pod curl-metrics-delete --ignore-not-found
