apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: delete-networkpolicy
spec:
  description: Verify deleting an augmented NetworkPolicy garbage collects the standard NetworkPolicy
  steps:
    - name: create-policy
      try:
        - apply:
            resource:
              apiVersion: networking.ayoy.se/v1alpha1
              kind: NetworkPolicy
              metadata:
                name: test-delete
              spec:
                podSelector:
                  matchLabels:
                    app: web
                policyTypes:
                  - Egress
                egress:
                  - ports:
                      - protocol: TCP
                        port: 443
                    to:
                      - hostname: kubernetes.default.svc.cluster.local
    - name: assert-standard-exists
      try:
        - assert:
            resource:
              apiVersion: networking.k8s.io/v1
              kind: NetworkPolicy
              metadata:
                name: test-delete
    - name: delete-augmented-policy
      try:
        - delete:
            ref:
              apiVersion: networking.ayoy.se/v1alpha1
              kind: NetworkPolicy
              name: test-delete
    - name: assert-standard-deleted
      try:
        - error:
            resource:
              apiVersion: networking.k8s.io/v1
              kind: NetworkPolicy
              metadata:
                name: test-delete
